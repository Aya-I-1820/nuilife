<!-- app/views/posts/show.html.erb -->
<div class="container py-4">
  <div class="form-narrow">

    <!-- 上部に“投稿一覧へ戻る” -->
    <div class="mb-3">
      <%= link_to "← 投稿一覧へ戻る", root_path(tab: "all"), class: "btn btn-sm btn-outline-primary" %>
    </div>

    <div class="mb-3 d-flex align-items-center gap-2">
      <%= link_to nui_path(@nui) do %>
        <%= nui_avatar_tag(@nui, size: 40) %>
      <% end %>
      <strong><%= @nui.name %></strong>
    </div>

    <% if @post.post.present? %>
      <p  class="post-content><%= simple_format(h(@post.post)) %></p>
    <% end %>

    <% if @post.image&.attached? %>
      <%= image_tag @post.image.variant(resize_to_limit: [400, 400]).processed,
                    class: "img-fluid rounded" %>
    <% end %>

    <!-- ♡ + カウント（同一ページにとどまる） -->
    <div class="mt-3 d-flex align-items-center gap-3 small">
      <div class="d-flex align-items-center">
        <% if user_signed_in? %>
          <% liked = @post.liked_users.exists?(current_user.id) %>
          <%= button_to [@post.nui, @post, :like],
                method: (liked ? :delete : :post),
                class: "btn btn-like p-0",
                form: { data: { turbo: "true" } } do %>
            <span class="like-heart <%= 'liked' if liked %>">♡</span>
            <span class="like-count"><%= @post.likes.size %></span>
          <% end %>
        <% else %>
          <span class="text-muted">♡ <%= @post.likes.size %></span>
        <% end %>
      </div>
    </div>

    <hr>
    <h2 class="h5 mt-4">コメント</h2>

    <% if @comments.any? %>
      <div class="vstack gap-3 mb-3">
        <% @comments.each do |c| %>
          <div class="d-flex align-items-start gap-2">
            <%= link_to nui_path(c.nui) do %>
              <%= nui_avatar_tag(c.nui, size: 28) %>
            <% end %>
            <div>
              <div class="small text-muted"><strong><%= c.nui.name %></strong></div>
              <div><%= simple_format(h(c.content)) %></div>
              <% if user_signed_in? && c.nui.user_id == current_user.id %>
                <div class="small">
                  <%= link_to "削除", [@nui, @post, c],
                              data: { turbo_method: :delete, turbo_confirm: "削除しますか？" } %>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <p class="text-muted">まだコメントがありません。</p>
    <% end %>

    <% if user_signed_in? %>
      <% user_nuis = current_user.nuis.where.not(id: nil) %>
      <% if user_nuis.exists? %>
        <h3 class="h6">コメントを書く</h3>
        <%= form_with model: [@nui, @post, Comment.new], local: true do |f| %>
          <div class="mb-2">
            <%= label_tag :nui_id, "どのぬいでコメントしますか？" %>
            <%= select_tag "comment[nui_id]",
                  options_from_collection_for_select(user_nuis, :id, :name),
                  class: "form-select" %>
          </div>
          <div class="mb-2">
            <%= f.text_area :content, rows: 3, class: "form-control",
                            placeholder: "コメントを入力…" %>
          </div>
          <%= f.submit "コメントする", class: "btn btn-primary btn-sm" %>
        <% end %>
      <% else %>
        <p class="text-muted">コメントするには、まず <%= link_to "ぬいを作成", new_nui_path %> してください。</p>
      <% end %>
    <% else %>
      <p class="text-muted">コメントするには <%= link_to "ログイン", new_user_session_path %> してください。</p>
    <% end %>

  </div>
</div>
