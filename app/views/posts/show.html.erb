<div class="container py-4">
<div class="form-narrow">

<div class="mb-3 d-flex align-items-center gap-2">
  <%= link_to nui_path(@nui) do %>
    <%= avatar_for(@nui, size: 40) %>
  <% end %>
  <strong><%= @nui.name %></strong>
</div>
<p><%= simple_format(h(@post.post)) %></p>

<% if @post.image&.attached? %>
  <%= image_tag @post.image.variant(resize_to_limit: [400, 400]).processed, class: "img-fluid rounded" %>
<% end %>



<hr>
<h2 class="h5 mt-4">コメント</h2>

<% if @comments.any? %>
  <div class="vstack gap-3 mb-3">
    <% @comments.each do |c| %>
      <div class="d-flex align-items-start gap-2">
        <%= link_to nui_path(c.nui) do %>
          <%= avatar_for(c.nui, size: 28) %>
        <% end %>
        <div>
          <div class="small text-muted"><strong><%= c.nui.name %></strong></div>
          <div><%= simple_format(h(c.content)) %></div>
          <% if user_signed_in? && c.nui.user_id == current_user.id %>
            <div class="small">
              <%= link_to "削除", [@nui, @post, c],
                          data: { turbo_method: :delete, turbo_confirm: "削除しますか？" } %>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>
<% else %>
  <p class="text-muted">まだコメントがありません。</p>
<% end %>


<% if user_signed_in? %>
  <% user_nuis = current_user.nuis.where.not(id: nil) %>
  <% if user_nuis.exists? %>
    <h3 class="h6">コメントを書く</h3>
    <%= form_with model: [@nui, @post, Comment.new], local: true do |f| %>
      <div class="mb-2">
        <%= label_tag :nui_id, "どのぬいでコメントしますか？" %>
        <%= select_tag "comment[nui_id]",
              options_from_collection_for_select(user_nuis, :id, :name),
              class: "form-select" %>
      </div>
      <div class="mb-2">
        <%= f.text_area :content, rows: 3, class: "form-control",
                        placeholder: "コメントを入力…" %>
      </div>
      <%= f.submit "コメントする", class: "btn btn-primary btn-sm" %>
    <% end %>
  <% else %>
    <p class="text-muted">コメントするには、まず <%= link_to "ぬいを作成", new_nui_path %> してください。</p>
  <% end %>
<% else %>
  <p class="text-muted">コメントするには <%= link_to "ログイン", new_user_session_path %> してください。</p>
<% end %>


<p>
  いいね数: <%= @post.likes.count %>
</p>

<% if user_signed_in? %>
  <% liked = @post.liked_users.exists?(current_user.id) %>

  <% if liked %>
    <%= button_to "いいね解除", [@post.nui, @post, :like], method: :delete %>
  <% else %>
    <%= button_to "いいね", [@post.nui, @post, :like], method: :post %>
  <% end %>
<% end %>

</div>
</div>